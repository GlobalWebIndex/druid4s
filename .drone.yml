clone:
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  run-tests:
    image: gwiq/sbt-docker:latest
    environment:
      - BROKER_HOST=musty-bear-druid-broker.default.svc.cluster.local
      - OVERLORD_HOST=musty-bear-druid-overlord.default.svc.cluster.local
    volumes:
      - /var/lib/docker/sbt:/cache
    commands:
      - sbt -mem 1024 -Djline.terminal=off -Dcoursier.cache=/cache/.coursier -Dsbt.ivy.home=/cache/.ivy2 -Divy.home=/cache/.ivy2 -Dfile.encoding=utf-8 -Dsbt.gigahorse=false test
    when:
      event: push

  publish-maven-artifacts:
    image: gwiq/sbt-docker:latest
    volumes:
      - /var/lib/docker/sbt:/cache
    commands:
      - sbt -mem 1024 -Djline.terminal=off -Dcoursier.cache=/cache/.coursier -Dsbt.ivy.home=/cache/.ivy2 -Divy.home=/cache/.ivy2 -Dfile.encoding=utf-8 druid4s-utils/publish druid4s-client/publish
    secrets: [ bintray_user, bintray_pass ]
    when:
      event: [deployment, tag]
